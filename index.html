<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="猿妙不可言" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="猿妙不可言">
<meta property="og:url" content="http://superhx.github.io/index.html">
<meta property="og:site_name" content="猿妙不可言">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="猿妙不可言">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://superhx.github.io/"/>





  <title>猿妙不可言</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-57494403-1', 'auto');
  ga('send', 'pageview');
</script>





</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">猿妙不可言</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2019/01/27/Error-Recover-and-Version-Check/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/27/Error-Recover-and-Version-Check/" itemprop="url">Error Recover and Version Check</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-27T19:28:39+08:00">
                2019-01-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/27/Error-Recover-and-Version-Check/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/01/27/Error-Recover-and-Version-Check/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近经常在工作中碰到需要访问分布式共享的资源。一般这种资源都是互斥访问。但免不了A最开始在修改，过了一段时间会话过期了，同一资源又被B修改，之后A回过神来又想修改该资源，一般这时候修改会失败。这时候A需要重新申请对该资源的互斥访问。假设A、B都可以执行对资源X的原子++操作，通常来说只希望A或者B其中一个对资源X进行++操作（负责资源X的原子++操作），但有可能出现以上情况，流程如下：</p>
<ol>
<li>A获取资源X的互斥锁；</li>
<li>A检查资源X的值等于1，准备修改为2；</li>
<li>但这时候A因为线程调度或者FullGC其他什么原因Hang住了，导致互斥锁会话过期，且资源X被分配给B负责；</li>
<li>这时候B又尝试获取X的互斥锁，资源X的值等于1，并将资源X的值修改为2，释放互斥锁；</li>
<li>这时候A回过神来，资源X又被分配给A负责</li>
<li>A准备修改资源X为2，但因为互斥锁过期了，所以需要重新获取；</li>
</ol>
<p>但是如果A重新获取互斥锁，然后直接修改资源X为2，那么就不满足+1的操作了。其实也就是B对资源X的修改被覆盖掉了。</p>
<p>这时候我们有两种选择：</p>
<ol>
<li>直接让A进行的操作失败，让上游重试或者错误向上传递；</li>
<li>让A重新进行所有的流程，获取资源X的互斥锁，得到资源X的值，然后修改资源X的值+1，释放互斥锁；</li>
</ol>
<p>如果采用第一种方式的话，我们原子++的操作的伪码如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acquire remote resource X exclude lock</span><br><span class="line">var x = value(X)</span><br><span class="line">set X = x + 1 // if error then throw exception</span><br><span class="line">release  remote resource X exclude lock</span><br></pre></td></tr></table></figure>
<p>细心的小老弟可以观察到每次操作都要获取远程的互斥锁，难免操作成本有点高。可以想到的优化方式，可以像数据库连接池一样复用这个互斥锁。优化代码如下，不仅仅没有重复获取和释放互斥锁，也减少了每次去获取资源X的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">synchronized atomicIncrement() &#123;</span><br><span class="line">    if don&apos;t acquire remote resource X exclude lock &#123;</span><br><span class="line">        recover();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        set X = ++x;  // if error then throw exception</span><br><span class="line">    &#125; catch(Throwable t) &#123;</span><br><span class="line">        recover();</span><br><span class="line">        throw t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">recover() &#123;</span><br><span class="line">    acquire remote resource X exclude lock</span><br><span class="line">    x = value(X)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之前的伪码可以抽象成通用的分布式资源独占访问模型如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">synchronized operateRemoteResource() &#123;</span><br><span class="line">    if don&apos;t acquire remote resource X exclude lock &#123;</span><br><span class="line">        recover();</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        check local x&apos;s info and</span><br><span class="line">        modify X</span><br><span class="line">    &#125; catch(Throwable t) &#123;</span><br><span class="line">        recover();</span><br><span class="line">        throw t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">synchronized recover() &#123;</span><br><span class="line">    acquire remote resource X exclude lock</span><br><span class="line">    x = get X&apos;s info</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一切看似很完美，我们还能怎么优化呢。假设check local x’s info是个耗时的操作，那将其从锁中移除，可以减少锁持有的时间。如果是直接移到锁外面，读到的local x’s info可能是stale的，因为从check local x’s info到operateRemoteResource可能因为修改异常已经重新recover过了，这时候local x’s info可能已经发生了变化，直接modify X其实是有问题的。</p>
<p>为了解决这个问题，我们可以通过类似MVCC的版本号，在check local x’s info 获取当前的version，然后在operateRemoteResource里面对比版本还是否一致，如果不一致，则说明已经重新recover过了，前面的检查是stale的local x’s info，这时候就需要放弃这次操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">opVersion = version</span><br><span class="line">check local x&apos;s info </span><br><span class="line"></span><br><span class="line">synchronized operateRemoteResource(opVersion) &#123;</span><br><span class="line">    if (opVersion &lt; version) &#123;</span><br><span class="line">        throw ex;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        modify X</span><br><span class="line">    &#125; catch(Throwable t) &#123;</span><br><span class="line">        recover();</span><br><span class="line">        throw t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">synchronized recover() &#123;</span><br><span class="line">    acquire remote resource X exclude lock</span><br><span class="line">    x = get X&apos;s info</span><br><span class="line">    version++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>最初的recover操作放到流程外</p>
</blockquote>
<p>如果这个分布式资源在多线程的情况下并不需要通过锁来进行互斥访问，这时候一般不会依赖X的信息，而只是访问修改X而已，那么代码又可以变成如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">operateRemoteResource() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        modify X</span><br><span class="line">    &#125; catch(Throwable t) &#123;</span><br><span class="line">        recover();</span><br><span class="line">        throw t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">synchronized recover() &#123;</span><br><span class="line">    acquire remote resource X exclude lock</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这种又会带来另一个问题，当多线程同时出现修改X异常，则会出现多次recover的场景，这个是我们不希望看到的。我们希望的是针对通过一次recover就能恢复的异常只recover一次。代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">operateRemoteResource() &#123;</span><br><span class="line">	opVersion = version</span><br><span class="line">	if (!recovering) &#123;</span><br><span class="line">        throw ex;</span><br><span class="line">	&#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        modify X</span><br><span class="line">    &#125; catch(Throwable t) &#123;</span><br><span class="line">        recover(opVersion);</span><br><span class="line">        throw t;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void recover(opVersion) &#123;</span><br><span class="line">    if (opVersion &lt; version || !recovering) &#123;</span><br><span class="line">    	return;</span><br><span class="line">    &#125;</span><br><span class="line">    synchronized &#123;</span><br><span class="line">        if (opVersion &lt; version || !recovering) &#123;</span><br><span class="line">    		return;</span><br><span class="line">    	&#125;</span><br><span class="line">    	recovering = false;</span><br><span class="line">    &#125;</span><br><span class="line">    synchronized &#123;</span><br><span class="line">        acquire remote resource X exclude lock</span><br><span class="line">        version++;</span><br><span class="line">        recovering = true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2018/10/21/chaos-engineering/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/21/chaos-engineering/" itemprop="url">Chaos Engineering 读书笔记</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-21T22:44:33+08:00">
                2018-10-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/21/chaos-engineering/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/21/chaos-engineering/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本来是准备写读后感的，呃，介于水平和时间有限（偷懒），准备“暂时”先写一篇读书笔记来记录一下自己看《Chaos Engineering》觉得有意思和有感悟的地方吧。</p>
<p>在看《Chaos Engineering》这本书之前，就对Netflix的Chaos Monkey有所耳闻。如Chaos Monkey的名字一下，Chaos Monkey负责在生产环境中进行捣乱，随意的关掉应用实例，来测试系统的健壮性。其实刚看到Chaos Monkey的时候，不由的想起测试中的Monkey Test。虽然两者不是同一个东西，但是觉得两者的核心相似：随机性、探索未知。随机性好理解，因为两者都有Monkey（滑稽）。那探索未知是啥呢？测试人员虽然在使用Chaos Monkey和Monkey Test，有对自己的系统行为有一定的预期，但并不像单元测试、集成测试之类这些测试一样，确切知道会发生什么。因为Chaos Monkey和Monkey Test具有随机性，测试人员希望利用随机性来发现未知的问题。</p>
<p>呃，有点跑题。。。下面读书笔记zhai chao正式开始。</p>
<h2 id="为什么需要Chaos-Engineering？"><a href="#为什么需要Chaos-Engineering？" class="headerlink" title="为什么需要Chaos Engineering？"></a>为什么需要Chaos Engineering？</h2><p>首先来看看Chaos Engineering的定义。定义是一种浓缩和总结，全书都是围绕这个定义来展开，感觉这个定义贼准确。建议看完这本书的同学可以回过头来好好品味下这句话。</p>
<blockquote>
<p>Chaos Engineering is an approach for learning about how your system behaves by appliying a discipline of empirical exploration.</p>
</blockquote>
<p>就像开头提到的Chaos Monkey，Chaos Engineering隐隐给人有一种测试的感觉。但是它又和传统的测试不同。传统的测试的目的更多的是测试程序的行为是否符合预期。而Chaos Engineering是一个通过实验发现“新”问题，然后解决问题的过程。一个是测试已知，一个是发现未知。</p>
<blockquote>
<p>In testing, an assertion is made: given specific conditions, a system will emit a specific output. Tests are typically binary, and determine whether a property is true or false. Strictly speaking, this does not generate new knowledge about the system, it just assigns valence to a known property of it. Experimentation generates <strong>new knowledge</strong>, and often suggests new avenues of exploration.</p>
</blockquote>
<p>而且测试通常只是针对一个子系统/程序，而在分布式的大环境下，是由很多微服务组成一个整体对外提供服务。有一些设计和错误恢复在单个子系统看来很合理，但是从整个系统上来看，就有可能引发灾难，例如请求重试导致的雪崩。还是因为系统复杂度的提高，有些问题可能是由好几个子系统共同处于某种状态导致的，单靠人是想不过来的（估计也想不出来），这时候就需要Chaos Engineering来帮我们提早发现问题，解决问题了。</p>
<p>Chaos Engineering这么好，那是不是就可以直接走起了？（斜眼）首先得问问自己：</p>
<blockquote>
<p>Is your system resilient to real-world events such as service failures and network latency spikes?</p>
</blockquote>
<p>如果明明知道自己某个节点挂一下就GG斯密达，有问题不修，那上这个不是找死嘛。</p>
<h2 id="Chaos-Engineering的原则"><a href="#Chaos-Engineering的原则" class="headerlink" title="Chaos Engineering的原则"></a>Chaos Engineering的原则</h2><p>好了好了，我知道Chaos Engineeing很好，那如果我想实践，那么它有哪些设计原则呢？</p>
<p>…说好的这周完成，偷懒，偷懒，最后一天才开始写 2018.10.21</p>
<h3 id="稳定状态的假定"><a href="#稳定状态的假定" class="headerlink" title="稳定状态的假定"></a>稳定状态的假定</h3><p>要知道一个系统的正确性，在某些条件下是否符合预期。首先我们得知道我们的预期是啥。怎么判断系统是否出于正常的状态（steady state）。都不知道系统什么算正常，怎么发现系统的异常呢。</p>
<p>观测系统状态比较常见的做法是通过指标（metrics）。指标分为系统指标和业务指标两种。</p>
<blockquote>
<p>System metrics：CPU load, memory utilization, network I/O, and all kinds of timing information, such as how long it takes to service web requests, or how much time is spent in various database queries.</p>
</blockquote>
<blockquote>
<p>It’s the business metrics that allow us to answer questions like:</p>
<ul>
<li>Are we losing customers?</li>
<li>Are the customers able to perform critical site functions like checking out or adding to their cart on an e-commerce site?</li>
<li>Are the customers experiencing so much latency that they will give up and stop using the service?</li>
</ul>
</blockquote>
<p>两者本质上都是时序数据，只是角度的不同。</p>
<p>指标的该配的配好了，那么问题又来了，我怎么知道指标是否是正常的。这是个难题，因为指标不像人的体温一样是一个相对问题的值。不要慌不要忙，数据建模帮你忙，虽然指标在一直变化，但是它有迹可循。</p>
<blockquote>
<p>It increases and decreases over time, but in a consistent way</p>
</blockquote>
<h3 id="Vary-Real-World-Events"><a href="#Vary-Real-World-Events" class="headerlink" title="Vary Real-World Events"></a>Vary Real-World Events</h3><p>只要时间够长，一切不可能都是可能。平时写代码也是一样，有些你觉得几乎不会发生，不会那么那么巧的事，到最后一定会发生。难道这就是墨菲定律！</p>
<blockquote>
<p>Every system, from simple to complex, is subject to unpredictable events and conditions if it runs long enough.</p>
</blockquote>
<p>现实生活中事件大概分如下几类：硬件故障、程序BUG、State transmission errors？、网络延迟、请求/输入大幅度波动和重试风暴、资源耗竭、Unusual or unpredictable combinations of interservice communication？、拜占庭将军问题（e.g. 一个节点自以为拥有最新的数据）、竞争和下游依赖故障。这些事件也许会同时发生，给你一记重拳。</p>
<p>这些事件的模拟的成本和带来的收益不尽相同，需要根据情况来权衡。</p>
<blockquote>
<p>We don’t need to enumerate all of the possible events that can change the system, we just need to inject the frequent and impactful ones as well as understand the resulting failure domains.</p>
</blockquote>
<h3 id="在生产环境实验"><a href="#在生产环境实验" class="headerlink" title="在生产环境实验"></a>在生产环境实验</h3><p>先声明：在生产环境实验，并不是没有脑子的在生产环境搞破环。</p>
<blockquote>
<ul>
<li>Make it easy to abort the experiment</li>
<li>Minimize the blast radius of the experiment</li>
</ul>
</blockquote>
<p>关于为什么要在生产环境实验？“越危险的地方，越能知道真理”</p>
<blockquote>
<p>We want to build confidence in the system in production, and to do that we need to explore the systemic effects there. Otherwise, we are just building confidence in a system other than the one we care about, which diminishes the value of the exercise.</p>
</blockquote>
<h3 id="自动化走起来"><a href="#自动化走起来" class="headerlink" title="自动化走起来"></a>自动化走起来</h3><p>不自动化，每一次实验都需要人去跟踪、观察和分析，那和“智能”运维脚本有什么区别。无时无刻不在自动的运行实验，确保系统的每次变更都经历了这些实验的“回归”，这才能增强我们对系统的信息嘛。</p>
<blockquote>
<p>If experimentation is not automated, it is obsolescent.</p>
</blockquote>
<h3 id="减小影响"><a href="#减小影响" class="headerlink" title="减小影响"></a>减小影响</h3><p>在生产环境实验，惊险又刺激。为了真的实验暴露出系统故障时的影响范围。实验要遵循两个原则：实验本身控制影响范围；当出现故障时，实验能够快速停止，及时止血。</p>
<h2 id="设计实验"><a href="#设计实验" class="headerlink" title="设计实验"></a>设计实验</h2><p>设计实验分为8个步骤：1）建立假设/预期；2）选择实验的范围；3）识别需要监控的指标；4）告知相关的部门；5）运行实验；6）分析结果；7）扩大影响范围；8）自动化</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2018/09/27/patch-map/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/27/patch-map/" itemprop="url">【瞎想系列】增量Map</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-27T14:25:17+08:00">
                2018-09-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/27/patch-map/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/27/patch-map/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="瞎想系列第一期-增量Map"><a href="#瞎想系列第一期-增量Map" class="headerlink" title="瞎想系列第一期 增量Map"></a>瞎想系列第一期 增量Map</h1><h2 id="这里有个需求"><a href="#这里有个需求" class="headerlink" title="这里有个需求"></a>这里有个需求</h2><p>将一个Map从Master同步到Slave</p>
<ul>
<li>最终达到一致就行</li>
<li>value变动的频率 &gt;&gt; key增加的频率 &gt;&gt; key减少的频率</li>
</ul>
<h2 id="简单粗暴"><a href="#简单粗暴" class="headerlink" title="简单粗暴"></a>简单粗暴</h2><p>最直接的想法就是直接使用推模式和拉模式：</p>
<ul>
<li>推模式：Master的Map发生变化，就往各个Slave推送整个Map</li>
<li>拉模式：Slave间隔向Master请求最新的Map数据</li>
</ul>
<p>这两种方式虽然简单粗暴易于实现，但每当Map有更新时，传输的是全量的Map的数据。在Map数据量小的时候尚可接受，但当Map数据量“大”、变动频繁和Slave数目过多时，就（大概）会对Master的带宽和负载造成巨大的压力。</p>
<p>为了解决这个问题，首先想到的是全量同步变增量同步。既然Slave有老的Map了，那Slave只需要拿到一个不定Patch，将补丁打入老的Map，就可以生成新的Map。那么问题又转变成如何生成补丁和如何打入补丁。</p>
<h2 id="伪“增量”Map"><a href="#伪“增量”Map" class="headerlink" title="伪“增量”Map"></a>伪“增量”Map</h2><p>为啥叫伪“增量”Map呢？呃，因为它的核心原理是Slave的key只增加和变更，不减少，然后通过其他补偿方案来删除key。</p>
<h3 id="核心设计"><a href="#核心设计" class="headerlink" title="核心设计"></a>核心设计</h3><h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    mapVersion: long // map的版本</span><br><span class="line">    map: &#123;</span><br><span class="line">        key1: &#123;</span><br><span class="line">            keyVersion: long, // key的版本</span><br><span class="line">            value: Object // key对应的value</span><br><span class="line">        &#125;,</span><br><span class="line">        key2: &#123;</span><br><span class="line">            keyVersion: long,</span><br><span class="line">            value: Object</span><br><span class="line">        &#125;, ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="map的版本-mapVersion"><a href="#map的版本-mapVersion" class="headerlink" title="map的版本 mapVersion"></a>map的版本 mapVersion</h4><p>mapVersion需要满足以下规约：</p>
<ul>
<li>mapVersion在map发生变更时版本会增大</li>
<li>mapVersion一定大于等于所有的keyVersion</li>
</ul>
<blockquote>
<p>map发生变更：添加新的key；key的value变化</p>
</blockquote>
<h4 id="key的版本-keyVersion"><a href="#key的版本-keyVersion" class="headerlink" title="key的版本 keyVersion"></a>key的版本 keyVersion</h4><p>keyVersion需要满足以下规约：</p>
<ul>
<li>keyVersion在key对应的value发生变更时版本会增大</li>
<li>keyVersion增大一定会比原来的mapVersion大</li>
<li>新增key的版本设置和key发生变更的规则一致</li>
</ul>
<h4 id="mapVersion和keyVersion更新流程"><a href="#mapVersion和keyVersion更新流程" class="headerlink" title="mapVersion和keyVersion更新流程"></a>mapVersion和keyVersion更新流程</h4><p>先更新keyVersion再更新mapVersion。</p>
<p>举个栗子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    mapVersion: 2</span><br><span class="line">    map: &#123;</span><br><span class="line">        key1: &#123; keyVersion: 1, value: Object &#125;,</span><br><span class="line">        key2: &#123; keyVersion: 2, value: Object &#125;,</span><br><span class="line">        key3: &#123; keyVersion: 1, value: Object &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>map的key1和key2的value都发生了变化</li>
<li>更新key1和key2大于原来的mapVersion，设置为3</li>
<li>更新mapVersion为最大的keyVersion，设置为3</li>
</ol>
<h4 id="同步策略"><a href="#同步策略" class="headerlink" title="同步策略"></a>同步策略</h4><ol>
<li>初次拉取设置mapVersion为空，Master返回全量map，Slave用全量map覆盖本地map</li>
<li>Master map发生变更，广播带mapVersion的oneway请求到Slave</li>
<li>Slave以本地map的mapVersion请求Master</li>
<li>Master根据mapVersion生成补丁返回给Slave</li>
</ol>
<p>Slave定时以mapVersion为空请求Master，Master返回全量map，Slave用全量map覆盖本地map</p>
<ul>
<li>为了清除已删除的key</li>
<li>防止广播没有收到</li>
</ul>
<h4 id="如何生成补丁"><a href="#如何生成补丁" class="headerlink" title="如何生成补丁"></a>如何生成补丁</h4><p>Slave请求的时候会带上Slave当前的mapVersion</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if slave.mapVersion == master.mapVersion</span><br><span class="line">    // 说明slave和master的map是一致的，无需变更</span><br><span class="line">	return noChangePatch</span><br><span class="line">else </span><br><span class="line">	patch = &#123; mapVersion: master.mapVersion, map: &#123;所有keyVersion比slave.mapVersion的项&#125; &#125;</span><br><span class="line">	return patch</span><br></pre></td></tr></table></figure>
<h4 id="如何打入补丁"><a href="#如何打入补丁" class="headerlink" title="如何打入补丁"></a>如何打入补丁</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if patch.mapVersion &lt; slave.mapVersion</span><br><span class="line">	return</span><br><span class="line">for k, v in path.map</span><br><span class="line">	// 这里的比较是为了即使是一个大补丁，也可以各取所需，例如slave本来只需要4和5之间的patch，master却返</span><br><span class="line">	// 回了2和5之间的patch</span><br><span class="line">	if v.keyVersion &gt; slave.map.map[k].keyVersion</span><br><span class="line">		slave.map.map[k] = v</span><br></pre></td></tr></table></figure>
<h4 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h4><h5 id="每次slave请求都要生成补丁？No！No！No！"><a href="#每次slave请求都要生成补丁？No！No！No！" class="headerlink" title="每次slave请求都要生成补丁？No！No！No！"></a>每次slave请求都要生成补丁？No！No！No！</h5><p>可以对补丁进行缓存。例如缓存分别和最新mapVersion相差1、4、16的补丁，请求补丁都返回大于等于版本差距的补丁，例如master.mapVersion - slave.mapVersion == 2，则返回补丁4。若相差超过16，就返回全量map。</p>
<h2 id="真增量Map"><a href="#真增量Map" class="headerlink" title="真增量Map"></a>真增量Map</h2><p>如果key删除的还算比较频繁，而且我想相对即使的知道key被删掉了。呃，那伪增量Map可能就不那么适用了。这时候就要请出人民的好伙伴好同志奥义-无敌-旋风-真增量Map。</p>
<p>真增量Map其实是对伪增量Map的一个改造，主要的不同点如下：</p>
<ul>
<li>map发生变更新增“key的删除”</li>
<li>key被删除的时候在Master这不会真的删除，只是标记DELETED，且keyVersion的变更流程和key的value发生变更的流程一致</li>
<li>打补丁的时候，Slave如果看到key标记为DELETED，则把key从map中移除</li>
</ul>
<p>加了DELETED标记就能解决key的删除，看起来这个方案很完美。</p>
<p>那么问题来了，Master map的key都不真正删除了，那之后Master的map不会越来越来大么？因此需要某种策略来裁剪map，移除掉已经删除的key。</p>
<p><strong>裁剪map核心思想</strong></p>
<p>越早标记为DELETED的key，越早删除，删除后，设置minPullMapVersion为最大已删的deleted key.keyVersion + 1。</p>
<p>如果slave拉取补丁的slave.mapVersion &lt; minPullMapVersion &amp;&amp; slave.mapVersion != master.mapVersion，则返回全量map，slave使用全量map覆盖本地map。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2018/07/29/避免装箱拆箱/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/29/避免装箱拆箱/" itemprop="url">避免装箱拆箱</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-29T22:05:31+08:00">
                2018-07-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/29/避免装箱拆箱/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/29/避免装箱拆箱/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Java自带Collection、Guava等类库，提供了便捷的Set、Map、List等常用数据结构。在日常开发中，这些数据结构已经满足我们的需求。这些数据结构是基于泛型实现的，提供了一个“架子”，用户可以自行设定里面的具体类型。但涉及到原始类型Primitive types（long、int、double…）作为数据结构中的元素时，因为Java泛型的限制，对这些数据结构的操作会带来很多“不必要的”原始类型的装箱和拆箱。<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Long, Long&gt; map = ...</span><br><span class="line">map.put(1L);</span><br><span class="line">long value = map.get(1L);</span><br></pre></td></tr></table></figure>
<p>相当于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Long, Long&gt; map = ...</span><br><span class="line">map.put(new Long(1L));</span><br><span class="line">long value = map.get(new Long(1L)).longValue();</span><br></pre></td></tr></table></figure>
<p>为了这些问题，出现了很多支持原生类型的集合类库例如<a href="http://trove.starlight-systems.com/" target="_blank" rel="noopener">Trove</a>、<a href="https://github.com/eclipse/eclipse-collections" target="_blank" rel="noopener">Eclipse Collections</a>、<a href="https://github.com/leventov/Koloboke" target="_blank" rel="noopener">koloboke</a>、<a href="http://fastutil.di.unimi.it/" target="_blank" rel="noopener">fastutil</a>和<a href="https://github.com/real-logic/Agrona" target="_blank" rel="noopener">argona</a>。</p>
<blockquote>
<p>具体的性能测试对比参见 <a href="https://github.com/austinv11/Long-Map-Benchmarks" target="_blank" rel="noopener">https://github.com/austinv11/Long-Map-Benchmarks</a></p>
</blockquote>
<p>从性能测试上来看Koloboke综合表现最好。但介于Koloboke在2016年后停滞在了1.0.0版本，用在生产环境还是有点虚的。论稳定性和功能的完整性，Eclipse Collections更胜一筹。</p>
<h2 id="Koloboke"><a href="#Koloboke" class="headerlink" title="Koloboke"></a>Koloboke</h2><p>下面通过long-long map来初窥一下Koloboke。</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><code>HashLongLongMap</code>除了实现<code>java.util.Map&lt;Long, Long&gt;</code>的所有接口以外，还提供了<code>long get(long key)</code>和<code>long put(long key, long value)</code>等支持原生类型操作的接口。让我们可以以较低的改造成本将HashMap换成Koloboke的对应实现。</p>
<p>注意：</p>
<ul>
<li>不支持<code>null</code> key、<code>null</code> value。</li>
<li>不支持多线程，但是是fail fast的。</li>
<li>不支持<code>Cloneable</code>、<code>Serializable</code>。</li>
<li>不能保证维持多于250,000,000个元素。当大小超过限制时，会抛出<code>HashOverflowException</code>。</li>
</ul>
<h3 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h3><p>koloboke实现类库需要针对每种原始类型编写相应的实现，因此类库包会比较大（19MB）（但是方便呀）。koloboke除了提供实现类库以外，还提供了<a href="https://koloboke.com/compile" target="_blank" rel="noopener">Compile</a>，用户可以根据自己的需要生成所需的类。除了按需生成，Compile生成的实现在某些特殊场景上还比koloboke实现类库快5%。</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p><code>HashLongLongMap</code>的实现类使用的实现方式和Java里面的<code>HashMap</code>不同，在解决Hash冲突时，使用的是开放地址法。如下图所示，它的key和value紧密相连。key存在偶数位，value存在相邻的奇数位。</p>
<img src="/2018/07/29/避免装箱拆箱/arrange.png" title="排布">
<p>优点：</p>
<ul>
<li>当Hash冲突时，不需要拉链，减少在添加和删除元素时的拉链的Node创建和销毁。</li>
<li>key和value在内存上紧密相连，（臆想）在同一缓存行，数据存取会比较快。</li>
<li>存储使用long[]数组，并提供原生类型操作接口，避免不必要的装箱拆箱。<br>缺点：</li>
<li>当Hash冲突时，需要另外寻找位点，插入和查询性能会降低。（其实这对于拉链法也是一样的，Hash冲突，需要拉链，查询性能会降低）。</li>
</ul>
<p>查找、插入和删除操作首先是找到key所在的位点index。index的计算方式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(mask(key)) &amp; (capacityMask = (tab.length) - 2)</span><br></pre></td></tr></table></figure>
<p>当index所在位置没有数据，即没有冲突时，就可以将<code>tab[index] = key; tab[index + 1] = value;</code>。如果冲突就设置<code>index = (index - 2) &amp; capacityMask</code>。</p>
<p>那么问题来了怎么判断是否有冲突呢？存入的key是啥都有可能呐，又不能设置为<code>null</code>表示没有设置过值。为了解决这个问题，这里很鸡贼的引入了一个freeValue的概念。正如freeValue这个名字，freeValue就是不存在Map的keys里面的一个自由自在的long值。</p>
<p>那么问题又来了，万一我插入的key的值和freeValue相等呢？那我能怎么办，只能换一个不存在的freeValue值咯。（并且把数组里面原来的老的freeValue换成新的freeValue）。</p>
<p>增和查知道了，那删就是直接把key所在的index设为freeValue，标记为没有数据就行了吧（<strong>并不</strong>）。之前其他的数据因为冲突可能找了好几次才找到空位。这里直接设置为freeValue，那这个位点前面的数据可能就找不到了。所以需要根据情况进行相应的数据移动。如下图所示，KEY2因为KEY1已经占据，所以到前面找了个位置。当KEY1删掉后，KEY2也要进行相应的移动，移动到KEY1的位置。</p>
<img src="/2018/07/29/避免装箱拆箱/delete.png" title="删除流程">
<p>删除移动的逻辑（简化版）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">indexToRemove = indexToShift = index</span><br><span class="line">while (true) &#123;</span><br><span class="line">    indexToShift -= 2</span><br><span class="line">    if (indexShift对应的key == freeValue) &#123;</span><br><span class="line">        break</span><br><span class="line">    &#125; else if (indexShift对应的数据可以移动到indexToRemove所在位置)&#123;</span><br><span class="line">        移动数据</span><br><span class="line">        indexToRmove = indexToShift</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Eclipse-Collections"><a href="#Eclipse-Collections" class="headerlink" title="Eclipse Collections"></a>Eclipse Collections</h2><blockquote>
<p>现有的原生类型类可能会出现OOM的BUG，详见 <a href="https://github.com/eclipse/eclipse-collections/pull/552" target="_blank" rel="noopener">ISSUE</a> 。预计在<span data-type="color" style="color:rgb(36, 41, 46)"><span data-type="background" style="background-color:rgb(255, 255, 255)"> </span></span>10.0 milestone version修复</p>
</blockquote>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p><code>LongLongHashMap</code>只提供了操作原生类型的接口，没有实现<code>java.util.Map&lt;Long, Long&gt;</code>，在改造的时候可能工作量较大。</p>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><p>Eclipse Collections的<code>LongLongHashMap</code>与前者的数据存储格式类似，都是KEY、VALUE紧密相邻存在一个数组中。不同的是它分别用key=0和key=1来表示空单元和被删除的单元。查找和插入的逻辑和Koloboke的<code>HashLongLongMap</code>类似，先找index，key冲突的话就去下一个位置找，匹配后key的index+1就是value存储的位置。</p>
<p>那么问题来了，那我要插入的数据的key为0或1怎么办（问题咋这么多）？<code>LongLongHashMap</code>使用了两个哨兵对象(sentinel object)来存储当key为0或1的值。查找、插入和删除都对这两个哨兵对象操作。</p>
<p>删除逻辑相对与Koloboke就简单很多，因为被删除的单元的key用1来表示，不需要在删除单元后移动其他的单元。只需要将被删除单元的key设置为1、value设置为0。</p>
<p>扩展阅读：</p>
<ul>
<li><a href="http://www.infoq.com/cn/articles/eclipse-collections" target="_blank" rel="noopener">Eclipse Collections随Java版本的演变</a></li>
</ul>
<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><p>测试程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@State</span>(Scope.Benchmark)</span><br><span class="line"><span class="comment">//@Fork(value = 1, jvmArgsAppend = "-Xmx 64m -Xms 64m -XX:+PrintGCDetails")</span></span><br><span class="line"><span class="meta">@Fork</span>(value = <span class="number">1</span>)</span><br><span class="line"><span class="meta">@Warmup</span>(iterations = <span class="number">1</span>)</span><br><span class="line"><span class="meta">@Measurement</span>(iterations = <span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PutDeleteTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>                      SIZE          = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MutableLongObjectMap&lt;TestValueObject&gt; eclipseLOMap  = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> MutableLongLongMap                    eclipseLLMap  = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> LongObjMap                            kolobokeLOMap = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> LongLongMap                           kolobokeLLMap = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Long, TestValueObject&gt;            jLOmap        = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Long, Long&gt;                       jLLmap        = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>                                  putIndex      = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">kolobokeLongLongMapTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (kolobokeLLMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            kolobokeLLMap = HashLongLongMaps.newMutableMap(<span class="number">2048</span>);</span><br><span class="line">            <span class="keyword">for</span> (; putIndex &lt; SIZE; putIndex++) &#123;</span><br><span class="line">                kolobokeLLMap.put(putIndex, putIndex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        kolobokeLLMap.put(putIndex, putIndex);</span><br><span class="line">        kolobokeLLMap.remove(putIndex - SIZE);</span><br><span class="line">        putIndex++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Benchmark</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eclipseHashLongLongMapTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (eclipseLLMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            eclipseLLMap = <span class="keyword">new</span> LongLongHashMap();</span><br><span class="line">            <span class="keyword">for</span> (; putIndex &lt; SIZE; putIndex++) &#123;</span><br><span class="line">                eclipseLLMap.put(putIndex, putIndex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        eclipseLLMap.put(putIndex, putIndex);</span><br><span class="line">        eclipseLLMap.remove(putIndex - SIZE);</span><br><span class="line">        putIndex++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> <span class="keyword">throws</span> RunnerException </span>&#123;</span><br><span class="line">        Options opt = <span class="keyword">new</span> OptionsBuilder().include(PutDeleteTest.class.getSimpleName()).addProfiler(GCProfiler.class)</span><br><span class="line">            .jvmArgsAppend(<span class="string">"-Xms4g"</span>, <span class="string">"-Xmx4g"</span>, <span class="string">"-XX:+PrintGCDetails"</span>).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Runner(opt).run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">PutDeleteTest.concurrentHashLongLongMapTest                                     thrpt    5  25222540.523 ±  2219795.461   ops/s</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.alloc.rate                      thrpt    5      2213.704 ±      194.760  MB/sec</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.alloc.rate.norm                 thrpt    5        96.659 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.churn.PS_Eden_Space             thrpt    5      2202.213 ±      361.536  MB/sec</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.churn.PS_Eden_Space.norm        thrpt    5        96.132 ±        9.404    B/op</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.churn.PS_Survivor_Space         thrpt    5         0.014 ±        0.023  MB/sec</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.churn.PS_Survivor_Space.norm    thrpt    5         0.001 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.count                           thrpt    5        85.000                 counts</span><br><span class="line">PutDeleteTest.concurrentHashLongLongMapTest:·gc.time                            thrpt    5        55.000                     ms</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest                                   thrpt    5  24952212.914 ±  1230098.599   ops/s</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.alloc.rate                    thrpt    5      2189.621 ±      107.990  MB/sec</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.alloc.rate.norm               thrpt    5        96.659 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.churn.PS_Eden_Space           thrpt    5      2201.926 ±      330.942  MB/sec</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.churn.PS_Eden_Space.norm      thrpt    5        97.186 ±       11.418    B/op</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.churn.PS_Survivor_Space       thrpt    5         0.017 ±        0.022  MB/sec</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.churn.PS_Survivor_Space.norm  thrpt    5         0.001 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.count                         thrpt    5        85.000                 counts</span><br><span class="line">PutDeleteTest.concurrentHashLongObjectMapTest:·gc.time                          thrpt    5        50.000                     ms</span><br><span class="line">PutDeleteTest.hashLongLongMapTest                                               thrpt    5  42870761.215 ± 18706977.204   ops/s</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.alloc.rate                                thrpt    5      4048.116 ±     1765.868  MB/sec</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.alloc.rate.norm                           thrpt    5       104.000 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.churn.PS_Eden_Space                       thrpt    5      4050.324 ±     1778.662  MB/sec</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.churn.PS_Eden_Space.norm                  thrpt    5       104.050 ±        5.407    B/op</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.churn.PS_Survivor_Space                   thrpt    5         0.027 ±        0.036  MB/sec</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.churn.PS_Survivor_Space.norm              thrpt    5         0.001 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.count                                     thrpt    5       156.000                 counts</span><br><span class="line">PutDeleteTest.hashLongLongMapTest:·gc.time                                      thrpt    5        87.000                     ms</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest                                             thrpt    5  44863139.823 ± 16865234.866   ops/s</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.alloc.rate                              thrpt    5      4236.239 ±     1592.934  MB/sec</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.alloc.rate.norm                         thrpt    5       104.000 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.churn.PS_Eden_Space                     thrpt    5      4232.196 ±     1681.207  MB/sec</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.churn.PS_Eden_Space.norm                thrpt    5       103.853 ±        6.346    B/op</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.churn.PS_Survivor_Space                 thrpt    5         0.027 ±        0.026  MB/sec</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.churn.PS_Survivor_Space.norm            thrpt    5         0.001 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.count                                   thrpt    5       163.000                 counts</span><br><span class="line">PutDeleteTest.hashLongObjectMapTest:·gc.time                                    thrpt    5        97.000                     ms</span><br><span class="line">PutDeleteTest.kolobokeLongLongMapTest                                           thrpt    5  43996155.514 ±  7379424.883   ops/s</span><br><span class="line">PutDeleteTest.kolobokeLongLongMapTest:·gc.alloc.rate                            thrpt    5        ≈ 10⁻⁴                 MB/sec</span><br><span class="line">PutDeleteTest.kolobokeLongLongMapTest:·gc.alloc.rate.norm                       thrpt    5        ≈ 10⁻⁶                   B/op</span><br><span class="line">PutDeleteTest.kolobokeLongLongMapTest:·gc.count                                 thrpt    5           ≈ 0                 counts</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest                                         thrpt    5  42801168.145 ±  3999300.909   ops/s</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.alloc.rate                          thrpt    5       932.827 ±       87.300  MB/sec</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.alloc.rate.norm                     thrpt    5        24.000 ±        0.001    B/op</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.churn.PS_Eden_Space                 thrpt    5       932.455 ±      222.476  MB/sec</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.churn.PS_Eden_Space.norm            thrpt    5        24.001 ±        6.043    B/op</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.churn.PS_Survivor_Space             thrpt    5         0.007 ±        0.015  MB/sec</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.churn.PS_Survivor_Space.norm        thrpt    5        ≈ 10⁻⁴                   B/op</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.count                               thrpt    5        36.000                 counts</span><br><span class="line">PutDeleteTest.kolobokeLongObjectMapTest:·gc.time                                thrpt    5        20.000                     ms</span><br></pre></td></tr></table></figure>
<p>更为详细的测试，分析，待续。。。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2018/01/20/为妹子准备的-Java-面试（2）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/20/为妹子准备的-Java-面试（2）/" itemprop="url">为妹子准备的 Java 面试（2）</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-20T20:20:56+08:00">
                2018-01-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/20/为妹子准备的-Java-面试（2）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/20/为妹子准备的-Java-面试（2）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="开场白"><a href="#开场白" class="headerlink" title="开场白"></a>开场白</h2><ul>
<li>参与人：啥都不知道 Amy Xia </li>
<li>参考书籍：数据结构（用面向对象方法与C++语言描述）</li>
<li>其他参考资料：网上“冲浪”搜寻来的博客</li>
<li>本篇目标：希望啥都不懂的 Amy Xia 根据问题自我学习自己筛选，希望以找到答案为目的的快速查阅</li>
</ul>
<h2 id="自问自答"><a href="#自问自答" class="headerlink" title="自问自答"></a>自问自答</h2><h3 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h3><h4 id="顺序表、单链表、循环链表和双向链表的结构、增删改查的方式和特点。"><a href="#顺序表、单链表、循环链表和双向链表的结构、增删改查的方式和特点。" class="headerlink" title="顺序表、单链表、循环链表和双向链表的结构、增删改查的方式和特点。"></a>顺序表、单链表、循环链表和双向链表的结构、增删改查的方式和特点。</h4><p>… 妹子已找到阿里的实习，勿念</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2018/01/13/为妹子准备的-Java-面试（1）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/13/为妹子准备的-Java-面试（1）/" itemprop="url">为妹子准备的 Java 面试（1）</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-13T15:37:09+08:00">
                2018-01-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/13/为妹子准备的-Java-面试（1）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/13/为妹子准备的-Java-面试（1）/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>正所谓磨刀不误砍柴工，基础打好了，其他的进阶才不至于被一叶障目。个人觉得 Java 基础由：基础语法、常用类库、网络编程、并发编程和 JVM 5个部分组成。这么多东西初看未免觉得无从下手，摸不着方向，觉得看不完（对，Amy Xia 同学说的就是你）。与其自己去摸索，不如直接使用大神的贤者之石。呃，其实就是看书看书看书（这么多经典的书不看，放着夹叶子嘛）。</p>
<h2 id="Java-语法基础准备"><a href="#Java-语法基础准备" class="headerlink" title="Java 语法基础准备"></a>Java 语法基础准备</h2><p>这部分主要是对 Java 语法基础的准备。Java 语法特性初看很简单，但是深入了解后，还是会有发现很多 tricky 的地方。相对比较难理解的部分就是重载/重写和泛型，如果不理解 Java 底层是如何处理这些东西，而是当纯靠死记硬背，可能面对某些复杂的情况，会有错误的判断。下面是 Java 基础准备所需要学习的书籍和文档：</p>
<ul>
<li><strong>Think In Java</strong></li>
<li><a href="https://docs.oracle.com/javase/tutorial/java/index.html" target="_blank" rel="noopener"><strong>Learning the Java Language</strong></a></li>
</ul>
<h2 id="自问自答环节"><a href="#自问自答环节" class="headerlink" title="自问自答环节"></a>自问自答环节</h2><p>这部分是对前期学习成果成果的一个检验，有些问题是面试的过程中碰到的，有些问题是自己看书的时候忽然产生的疑问或者之前知识点遗漏的地方。</p>
<p>3 。。。2。。1。Start</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><h4 id="public、protected、no-modifier、private-四种-modifier的access-layer有什么区别？介绍一下-Java-9-的模块化。"><a href="#public、protected、no-modifier、private-四种-modifier的access-layer有什么区别？介绍一下-Java-9-的模块化。" class="headerlink" title="public、protected、no modifier、private 四种 modifier的access layer有什么区别？介绍一下 Java 9 的模块化。"></a>public、protected、no modifier、private 四种 modifier的access layer有什么区别？介绍一下 Java 9 的模块化。</h4><h4 id="重载-overload-和重写-override-的区别。"><a href="#重载-overload-和重写-override-的区别。" class="headerlink" title="重载 overload 和重写 override 的区别。"></a>重载 overload 和重写 override 的区别。</h4><h4 id="List、List-lt-gt-和-List-lt-Object-gt-的异同是什么？各自的使用场景？"><a href="#List、List-lt-gt-和-List-lt-Object-gt-的异同是什么？各自的使用场景？" class="headerlink" title="List、List&lt;?&gt; 和 List&lt;Object&gt; 的异同是什么？各自的使用场景？"></a><code>List</code>、<code>List&lt;?&gt;</code> 和 <code>List&lt;Object&gt;</code> 的异同是什么？各自的使用场景？</h4><h4 id="思考-Number-num-new-LinkedList-lt-Integer-gt-get-0-在编译后的等价代码是什么？"><a href="#思考-Number-num-new-LinkedList-lt-Integer-gt-get-0-在编译后的等价代码是什么？" class="headerlink" title="思考 Number num = (new LinkedList&lt;Integer&gt;()).get(0)在编译后的等价代码是什么？"></a>思考 <code>Number num = (new LinkedList&lt;Integer&gt;()).get(0)</code>在编译后的等价代码是什么？</h4><h4 id="List-lt-extends-Foo-gt-和-List-lt-super-Foo-gt-的异同是什么？各自的使用场景？"><a href="#List-lt-extends-Foo-gt-和-List-lt-super-Foo-gt-的异同是什么？各自的使用场景？" class="headerlink" title="List&lt;? extends Foo&gt;和 List&lt;? super Foo&gt;的异同是什么？各自的使用场景？"></a><code>List&lt;? extends Foo&gt;</code>和 <code>List&lt;? super Foo&gt;</code>的异同是什么？各自的使用场景？</h4><h4 id="下面这段代码输出是什么？顺便思考子类对象的内存结构。"><a href="#下面这段代码输出是什么？顺便思考子类对象的内存结构。" class="headerlink" title="下面这段代码输出是什么？顺便思考子类对象的内存结构。"></a>下面这段代码输出是什么？顺便思考子类对象的内存结构。</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> String str = <span class="string">"Foo"</span>;</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="title">Foo</span><span class="params">()</span> </span>&#123; say(); &#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">"Call method in Foo with str value:"</span> + str); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">Foo</span></span>&#123;</span><br><span class="line">  	<span class="keyword">public</span> String str = <span class="string">"Bar"</span>;</span><br><span class="line">  	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123; System.out.println(<span class="string">"Call method in Bar with str value:"</span> + str); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// in main</span></span><br><span class="line">Foo obj = <span class="keyword">new</span> Bar();</span><br><span class="line">System.out.println(<span class="string">"Str value: "</span> + obj.str);</span><br><span class="line">obj.say();</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="下面这段代码是否有错？若有错，为什么？"><a href="#下面这段代码是否有错？若有错，为什么？" class="headerlink" title="下面这段代码是否有错？若有错，为什么？"></a>下面这段代码是否有错？若有错，为什么？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">getResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">double</span> <span class="title">getResult</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">0.0</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？"><a href="#下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？" class="headerlink" title="下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？"></a>下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(List&lt;Integer&gt; intList)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">double</span> <span class="title">sum</span><span class="params">(List&lt;Double&gt; doubleList)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0.0</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="下面这段代码是否有错？若有错，为什么？若没有错，输出是什么？顺便还可以思考编译时发生了什么？"><a href="#下面这段代码是否有错？若有错，为什么？若没有错，输出是什么？顺便还可以思考编译时发生了什么？" class="headerlink" title="下面这段代码是否有错？若有错，为什么？若没有错，输出是什么？顺便还可以思考编译时发生了什么？"></a>下面这段代码是否有错？若有错，为什么？若没有错，输出是什么？顺便还可以思考编译时发生了什么？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Double</span>&gt; </span>&#123;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T t)</span> </span>&#123; System.out.println(<span class="string">"Set Foo"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Integer</span>&gt; <span class="keyword">extends</span> <span class="title">Foo</span></span>&#123;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T t)</span> </span>&#123; System.out.println(<span class="string">"Set Bar"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// In main</span></span><br><span class="line">Bar&lt;Integer&gt; bar = <span class="keyword">new</span> Bar&lt;&gt;();</span><br><span class="line">bar.set(<span class="number">1</span>);</span><br><span class="line">bar.set(<span class="number">1.0</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？-1"><a href="#下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？-1" class="headerlink" title="下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？"></a>下面这段代码是否有错？若有错，为什么？顺便还可以思考编译时发生了什么？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T t)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">Foo</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Integer t)</span> </span>&#123;&#125;</span><br><span class="line"> 	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Object t)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="下面这段代码的输出是什么？顺便思考对象的初始化流程，以ClassLoader为起点。"><a href="#下面这段代码的输出是什么？顺便思考对象的初始化流程，以ClassLoader为起点。" class="headerlink" title="下面这段代码的输出是什么？顺便思考对象的初始化流程，以ClassLoader为起点。"></a>下面这段代码的输出是什么？顺便思考对象的初始化流程，以ClassLoader为起点。</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Main start\n"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Before new a B object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> B();</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"After new a B object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(C.constCvar);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(C.staticCVar);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Before new a C object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> C();</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"After new a C object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Main end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Out</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Out</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"-------------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Out</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Out o1 = <span class="keyword">new</span> Out(<span class="string">"A static member o1 initialize"</span>);</span><br><span class="line">    <span class="keyword">public</span> Out o2 = <span class="keyword">new</span> Out(<span class="string">"A member o2 initialize"</span>);</span><br><span class="line"></span><br><span class="line">    &#123; <span class="keyword">new</span> Out(<span class="string">"A non-static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="keyword">new</span> Out(<span class="string">"A static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123; <span class="keyword">new</span> Out(<span class="string">"A constructor execute"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Out o3 = <span class="keyword">new</span> Out(<span class="string">"B static member o3 initialize"</span>);</span><br><span class="line">    <span class="keyword">public</span> Out o4 = <span class="keyword">new</span> Out(<span class="string">"B member o4 initialize"</span>);</span><br><span class="line"></span><br><span class="line">    &#123; <span class="keyword">new</span> Out(<span class="string">"B non-static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="keyword">new</span> Out(<span class="string">"B static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>&#123; <span class="keyword">new</span> Out(<span class="string">"B constructor execute"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String constCvar = <span class="string">"const C member"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String staticCVar = <span class="string">"static C member"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="keyword">new</span> Out(<span class="string">"C static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">()</span></span>&#123; <span class="keyword">new</span> Out(<span class="string">"C constructor execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Java-基础类库准备"><a href="#Java-基础类库准备" class="headerlink" title="Java 基础类库准备"></a>Java 基础类库准备</h2><p>基础类库的准备主要从两方面进行，一方面是使用相关：适用场景、使用方式。适用场景：通过接口的整体描述，了解在实现某个功能，需要使用什么样的类库。使用方式：类/接口的方法、方法的作用；另一方面是实现相关：实现的方式和实现的优缺点。对类库使用的了解，仅仅是赋予我们能写代码的能力，而对类库实现的了解，不仅能赋予我们会写代码的能力，更多的是，通过了解实现，给予我们新的思路，在类库功能不能完成需求的情况下，可以自己造轮子。</p>
<p>基础类库准备的方式，使用相关信息可以从 API 文档获得，实现相关信息可以从 API 文档 + 源码来了解。（注：从源码了解，并不代表要一行一行的把源码看完，可以只需要了解核心的实现，忽略某些实现细节，大概对实现有个掌控就行）</p>
<p>基础类库包括：数据结构、线程池</p>
<blockquote>
<p>斜体代表要阅读源码，源码可以放到有空再读</p>
</blockquote>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><ul>
<li>链表：接口 List；实现类 <em>LinkedList</em>、<em>ArrayList</em></li>
<li>Map：接口 Map；实现类 <em>HashMap</em>、HashTable、TreeMap、<em>LinkedHashMap</em>、WeakHashMap</li>
<li>Set：接口 Set；实现类 <em>HashSet</em>、LinkedHashSet、TreeSet</li>
<li>队列：接口 Queue；实现类 ArrayBlockingQueue、ConcurrentLinkedQueue、DelayQueue, LinkedBlockingQueue、LinkedTransferQueue、PriorityBlockingQueue、PriorityQueue、SynchronousQueue</li>
<li>Deque：接口 Deque；实现类 ArrayDeque、ConcurrentLinkedDeque、LinkedBlockingDeque</li>
</ul>
<h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><ul>
<li>ThreadPoolExecutor</li>
<li>ScheduledThreadPoolExecutor</li>
<li>ForkJoinPool</li>
<li>Thread</li>
</ul>
<h3 id="BIO-amp-NIO"><a href="#BIO-amp-NIO" class="headerlink" title="BIO &amp; NIO"></a>BIO &amp; NIO</h3><ul>
<li><a href="http://tutorials.jenkov.com/java-io/index.html" target="_blank" rel="noopener">Java IO Tutorial</a></li>
<li><a href="http://tutorials.jenkov.com/java-networking/index.html" target="_blank" rel="noopener">Java Socket</a></li>
<li><a href="http://tutorials.jenkov.com/java-nio/index.html" target="_blank" rel="noopener">Java NIO Tutorial</a></li>
</ul>
<h2 id="自问自答环节-1"><a href="#自问自答环节-1" class="headerlink" title="自问自答环节"></a>自问自答环节</h2><p>…</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2018/01/10/ForkJoinPool-探索/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/10/ForkJoinPool-探索/" itemprop="url">ForkJoinPool 探索</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-10T14:19:40+08:00">
                2018-01-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/10/ForkJoinPool-探索/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/10/ForkJoinPool-探索/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>“分而治之“是理清思路和解决问题的一个重要的方法。大到系统架构对功能模块的拆分，小到归并排序的实现，无一不在散发着分而治之的思想。在实现分而治之的算法的时候，我们通常使用递归的方法。递归相当于把大的任务拆成多个小的任务，然后大任务等待多个小的子任务执行完成后，合并子任务的结果。一般来说，父任务依赖与子任务的执行结果，子任务与子任务之间没有依赖关系。因此子任务之间可以并发执行来提升性能。于是<code>ForkJoinPool</code>提供了一个并发处理“分而治之”的框架，让我们能以类似于递归的编程方式获得并发执行的能力。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>分而治之代码典型的形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result <span class="title">solve</span><span class="params">(Problem problem)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (problem is small) &#123;</span><br><span class="line">        directly solve problem</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        split problem into independent parts</span><br><span class="line">        fork <span class="keyword">new</span> subtasks to solve each part</span><br><span class="line">        join all subtasks</span><br><span class="line">        compose result from subresults</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>计算斐波那契数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Class Fibonacci extends RecursiveTask&lt;Integer&gt; &#123;</span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">int</span> n;</span><br><span class="line">   Fibonacci(<span class="keyword">int</span> n) &#123; <span class="keyword">this</span>.n = n; &#125;</span><br><span class="line">   <span class="function">Integer <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (n &lt;= <span class="number">1</span>)</span><br><span class="line">       <span class="keyword">return</span> n;</span><br><span class="line">     Fibonacci f1 = <span class="keyword">new</span> Fibonacci(n - <span class="number">1</span>);</span><br><span class="line">     f1.fork();</span><br><span class="line">     Fibonacci f2 = <span class="keyword">new</span> Fibonacci(n - <span class="number">2</span>);</span><br><span class="line">     <span class="keyword">return</span> f2.compute() + f1.join();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><code>ForkJoinPool</code>的核心在于其轻量级的调度机制，采用了Cilk的work-stealing的基本调度策略：</p>
<ul>
<li>每个工作线程维持一个任务队列</li>
<li>任务队列以双端队列的形式维护，不仅支持先进后出的<code>push</code>和<code>pop</code>操作，还支持先进先出的take操作</li>
<li>由父任务<code>fork</code>出来的子任务被<code>push</code>到运行该父任务的工作线程对应的任务队列中</li>
<li>工作线程以先进后出的方式处理<code>pop</code>自己任务队列中的任务（优先处理最年轻的任务）</li>
<li>当任务队列中没有任务时，工作线程尝试随机从其他任务队列中窃取任务</li>
<li>当工作线程没有任务可以执行，且窃取不到任务时，它会“退出”（yiled、sleep、优先级调整），经过一段时间后再次尝试。除非其他所有的线程也都没有任务可以执行，这种情况下它们会一直阻塞直到有新的任务从上层添加进来</li>
</ul>
<p>一个简单的实现：</p>
<script src="https://gist.github.com/superhx/33b53705e98bff6fd3505e69e0712abd.js"></script>



<p>参考资料：</p>
<ul>
<li>A Java Fork/Join Framework</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2018/01/08/流量控制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/08/流量控制/" itemprop="url">流量控制</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-08T16:55:41+08:00">
                2018-01-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/01/08/流量控制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/01/08/流量控制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>无论是整个系统，还是系统的各个模块，都有自己的负载承受能力。最直观的从系统层面来说，我们往往会提到这个系统能够承载的 TPS 是多少，这个 TPS 也一般作为系统提供服务能力的体现。若 TPS 超过了系统能够承载的上限，系统就可能出现 SLA 不满足客户需求，甚至于即使之后 TPS 下降到低于 TPS上限，系统仍不能恢复正常的情况。因此对系统服务访问的限流是至关重要的，通过控制访问系统的 TPS，从而达到保护系统的目的。本文将会介绍一些常见的限流算法。</p>
<h2 id="算法介绍"><a href="#算法介绍" class="headerlink" title="算法介绍"></a>算法介绍</h2><h3 id="滑动窗口算法"><a href="#滑动窗口算法" class="headerlink" title="滑动窗口算法"></a>滑动窗口算法</h3><p>我们最初可能是从 TCP 网络协议接触到滑动窗口（<a href="https://en.wikipedia.org/wiki/Sliding_window_protocol" target="_blank" rel="noopener">Sliding Window</a>）。在 TCP 网络协议中，滑动窗口里面的槽位放置的可以发送但还没有发送成功的 segment。下面要介绍的滑动窗口限流算法，虽然形式上看起来和 TCP 中的滑动窗口略有相似，实际本质上有很大的不同。</p>
<p>以图为例，滑动窗口限流算法的槽位（Sliding Cell）对应的是时间段和该时间段的请求次数，例如图中第一个槽位代表的就是时间段 0.0s~0.1s 和这个时间段内的请求次数。假设当前时间是 1.0s，想得知最近一秒钟的 tps，就可以通过将 0.0s~1.0s之间的所有槽位的计数器相加来计算。当时间过去 0.1s ，滑动窗口整体向后移动一个槽位，0.1~1.1s之间的槽位计数器总和即最近一秒钟 tps。以此类推。</p>
<p>不难看出滑动窗口的精度与在滑动窗口中分割的槽位的个数有很大的关系，槽位个数越多，滑动窗口限流越精确，移动更加平滑，当槽位个数退化为一个的时候，滑动窗口限流退化成计数器法限流。</p>
<img src="/2018/01/08/流量控制/sliding_window.png" title="Sliding Window">
<script src="https://gist.github.com/superhx/304b77c503d39c948c028e70db28efd8.js"></script>

<h3 id="漏斗桶算法"><a href="#漏斗桶算法" class="headerlink" title="漏斗桶算法"></a>漏斗桶算法</h3><p>漏斗桶算法有<a href="https://en.wikipedia.org/wiki/Leaky_bucket" target="_blank" rel="noopener">两种理解方式</a>，一种是作为度量器（meter），一种是作为队列（queue）。两种理解方式的基础都是漏桶，所以下面先介绍漏桶的原理，再介绍两种理解方式的差别。</p>
<p>如下图所示，每次请求都会将水滴带入到水中。当水桶仍然能够装下水滴时，允许执行后续的业务逻辑；当水桶已满，后续的水滴就会溢出来，拒绝执行后续的业务逻辑。与此同时，水桶下面有个孔洞，以恒定的速率不断往下滴水，给水桶腾挪出容量。（有点像小学的水池同时蓄水和防水的题目 2333）</p>
<img src="/2018/01/08/流量控制/leaky_bucket.png" title="Leaky Bucket">
<h4 id="度量器-Meter"><a href="#度量器-Meter" class="headerlink" title="度量器 Meter"></a>度量器 Meter</h4><p>漏斗桶算法从度量器来理解，和前面介绍的滑动窗口算法类似、是后面要介绍的令牌桶算法的镜像算法（一个是判断桶还有没有容量、一个是判断桶里面有没有令牌，一个是恒定速率漏水、一个是恒定速率增加令牌）。从程序执行的角度来看，当成功往桶里加水（允许执行），就代表后续的业务逻辑可以立即执行了（同步），起到了限流的作用。</p>
<script src="https://gist.github.com/superhx/6c66f5ebb9f8bdb848a3937ba1306424.js"></script>

<h4 id="队列-Queue"><a href="#队列-Queue" class="headerlink" title="队列 Queue"></a>队列 Queue</h4><p>漏斗桶算法从队列来理解，限流的原理是和度量器类似的，不同的地方在于，后续业务逻辑的执行。当成功往桶里加水，后续的业务逻辑（task）被放到队列中，以先进先出、恒定的速率异步的执行。因此相比度量器的方式，队列的方式除了能够限流以外，还多了整流的功能。请求的速率是不均匀的，不可预测的，通过这种的方式，可以将请求整流成可预测、恒定的速率来执行。</p>
<script src="https://gist.github.com/superhx/a62ec632cd5c5b1881e7514f06733026.js"></script>

<h3 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h3><p>令牌桶算法和漏桶的度量器实现比较类似。请求需要从桶中获取令牌，有令牌才能执行后续的业务逻辑。令牌以恒定的速率往桶里填充，当桶满时，令牌溢出。</p>
<img src="/2018/01/08/流量控制/token_bucket.png" title="Token Bucket">
<script src="https://gist.github.com/superhx/f2dc8f6c1c13593ac5573f235885e21f.js"></script>

<h3 id="其他相关实现"><a href="#其他相关实现" class="headerlink" title="其他相关实现"></a>其他相关实现</h3><p><a href="https://google.github.io/guava/releases/19.0/api/docs/index.html?com/google/common/util/concurrent/RateLimiter.html" target="_blank" rel="noopener">Guava RateLimiter</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2016/09/01/Java-Concurrency-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/01/Java-Concurrency-2/" itemprop="url">Java Concurrency [2]</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-09-01T16:46:14+08:00">
                2016-09-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/09/01/Java-Concurrency-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/09/01/Java-Concurrency-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="PREFACE"><a href="#PREFACE" class="headerlink" title="PREFACE"></a>PREFACE</h2><p>第一部分讲述了Java Concurrency的基础知识，第二部分来简单的介绍一下Java的java.util.concurrent类库。这篇写着写着还是觉得官方文档比较清楚详细23333，建议还是把整个concurrent package的官方文档读了。</p>
<h2 id="LIBRARY"><a href="#LIBRARY" class="headerlink" title="LIBRARY"></a>LIBRARY</h2><h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><p>ConcurrentHashMap提供和HashMap相同的功能，正如名字所表现的一样，ConcurrentHashMap同时还提供了同步机制。ConcurrentHashMap和对整个方法使用synchronized来达到同步的效果不同，它采用了更加细粒度的锁，以提高并发和可扩展性。</p>
<p>查询retrieve操作（包括get）通常不会被阻塞，因此在A线程对Map进行更新update操作（包括put、remove）的时候，线程B可以完成查询操作。查询操作得到的结果是最近在查询操作之前完成的更新操作所改变的状态，也就是说所有更新操作满足happens-before查询操作。但对于聚合aggregate操作（putAll、clear），并发的查询操作可能会得到一些“中间状态”，比如查到部分加入或者删除的entries。</p>
<p>在通过iterator对ConcurrentHashMap的entries进行遍历的同时，我们还可以对ConcurrentHashMap进行更新操作，而不会抛出ConcurrentModificationException的异常（注意，在设计中iterators一次只被一个线程所使用？？不知道指的是一个iterator只被一个线程所使用（个人倾向）？还是在同一时间只能有一个iterator被使用）</p>
<p>See also:</p>
<ul>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html" target="_blank" rel="noopener">ConcurrentHashMap</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentSkipListMap.html" target="_blank" rel="noopener">ConcurrentSkipListMap</a></li>
</ul>
<h3 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h3><p>CopyOnWriteArrayList是synchronized list的替代版本，它在某些常见的情形（iteration的频率远远大于更新的频率）下提供了更好的并发行，且省去了在iteration时候对锁的需要，和ConcurrentHashMap类似，在iterator的过程中，CopyOnWriteArrayList的修改并不会引起ConcurrentModificationException。</p>
<p>CopyOnWriteArrayList的每次更新操作都会创建一个新的副本。Iterators保留的数组引用是iteration开始时CopyOnWriteArrayList底层数组的快照，因为该数组永远都不会改变，所以我们也无需额外的同步。</p>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><p>BlockingQueue提供put/take和offer/poll。如果Queue是满的，put操作会阻塞直到有空间；如果Queue是空的take操作会阻塞直到Queue之中有元素。而offer(E e)会在Queue为满时，直觉返回false，也可以offer(E e, long timeout, TimeUnit unit)等待一段时间，同理pool。Queue通常会用在生产者消费者模式上，一边生产put，一边消费take，Queue简直天生为此。</p>
<p>See also:</p>
<ul>
<li>LinkedBlockingQueue</li>
<li>ArrayBlockingQueue</li>
<li>DelayQueue</li>
<li>PriorityBlockingQueue</li>
</ul>
<h3 id="Latch"><a href="#Latch" class="headerlink" title="Latch"></a>Latch</h3><p>Latch中文名字门闩，常常被用在线程C等待其他线程A、B条件后再继续执行的情形。CountDownLatch。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in somewhere</span></span><br><span class="line">CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread A</span></span><br><span class="line"><span class="comment">// ... do something</span></span><br><span class="line">latch.countDown();</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line"><span class="comment">// ... do something</span></span><br><span class="line">latch.countDown();</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread C</span></span><br><span class="line"><span class="comment">// ... do something</span></span><br><span class="line">latch.await(); <span class="comment">// waiting util latch count down to zero</span></span><br><span class="line"><span class="comment">// ... do something</span></span><br></pre></td></tr></table></figure>
<p>还有另外一种类似的情形，不过不是Latch，一组线程都互相等待直到大家都达到某个边界情况。当A、B都执行到barrier.await()时，线程A、B才会向下继续执行。还可以通过添加Runnable的形式CyclicBarrier(int parties, Runnable barrierAction)，增加后置的处理工作，当线程A、B都执行到await时，barrierAction会被执行。CyclicBarrier</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in somewhere</span></span><br><span class="line">CyclicBarrier barrier = <span class="keyword">new</span> CyclicBarrier(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread A</span></span><br><span class="line"><span class="comment">// ... do something</span></span><br><span class="line">latch.await();</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line"><span class="comment">// ... do something</span></span><br><span class="line">latch.await();</span><br><span class="line">Semaphore</span><br></pre></td></tr></table></figure>
<p>信号量Semaphore这个词让我回想起了那一天曾经被操作系统的过桥问题支配深深的恐惧。Semaphore适合控制资源的线程访问数量的场景，通过acquire来获得权限，release来释放权限。如下面程序所示，当线程A、B分别acquire，且还未release之前，线程C会被阻塞在acquire上，直到A或B调用release。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in somewhere</span></span><br><span class="line">Semaphore available = <span class="keyword">new</span> Semaphore(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread A</span></span><br><span class="line">available.acquire();</span><br><span class="line"><span class="comment">// ...do something</span></span><br><span class="line">available.release();</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread B</span></span><br><span class="line">available.acquire();</span><br><span class="line"><span class="comment">// ...do something</span></span><br><span class="line">available.release();</span><br><span class="line"></span><br><span class="line"><span class="comment">// thread C</span></span><br><span class="line">available.acquire();</span><br><span class="line"><span class="comment">// ...do something</span></span><br><span class="line">available.release();</span><br></pre></td></tr></table></figure>
<h3 id="Remaining…"><a href="#Remaining…" class="headerlink" title="Remaining…"></a>Remaining…</h3><p>还是把官方文档全都看一遍吧，写起来太无聊！！！</p>
<h2 id="HOW-TO-WRITE-A-CONCURRENT-PROGRAM"><a href="#HOW-TO-WRITE-A-CONCURRENT-PROGRAM" class="headerlink" title="HOW TO WRITE A CONCURRENT PROGRAM"></a>HOW TO WRITE A CONCURRENT PROGRAM</h2><h3 id="Explicitly-Creating-Threads-for-Tasks"><a href="#Explicitly-Creating-Threads-for-Tasks" class="headerlink" title="Explicitly Creating Threads for Tasks"></a>Explicitly Creating Threads for Tasks</h3><p>最简单的方式就是显式的创建Thread并且调用start()开始任务并发的执行。</p>
<p>通常通过显式的创建Thread执行并发任务有两种方式。</p>
<h4 id="继承Thread"><a href="#继承Thread" class="headerlink" title="继承Thread"></a>继承Thread</h4><p>继承Thread，将所需执行的任务重写入run()方法中。使用start()方法来启动线程。</p>
<p>注意是调用start()来启动线程，而不是run()。调用run()只会像正常的方法调用一样，顺序执行run()中的代码，执行完毕后继续执行调用run()之后的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// your task ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String ... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> MyTask().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现Runnable"><a href="#实现Runnable" class="headerlink" title="实现Runnable"></a>实现Runnable</h4><p>实现Runnable接口，将所需执行的任务写入run()方法中。再用实现Runnable接口的对象作为参数传入Thread的构造函数来实例化Thread对象。最后调用Thread的start()来启动线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// you task ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String ... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> MyTask()).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两种方式都最终需要显示的创建Thread来执行任务。这些Threads执行完毕以后就会被销毁。然而Thread的创建和销毁都需要较多的时间，这就给程序带来了延迟和资源负担。如果执行的任务都是轻量级的，且很频繁，正如很多服务器程序一样，为每个请求都创建一个新的Thread会消耗系统大量的计算资源。</p>
<h3 id="The-Executor-Framework"><a href="#The-Executor-Framework" class="headerlink" title="The Executor Framework"></a>The Executor Framework</h3><p>前面两种方式线程执行完任务就被销毁了，不免会有点浪费。为了减少线程的创建和销毁，让线程活得重于泰山，线程池应运而生。线程池有两个重要的组成部分：Queue（任务寄存处），Worker（处理任务的工人）。最简单的线程池实现如下。提交任务#submit就是把任务放入任务寄存处中。处理任务的工人不断的从任务寄存处中取出任务#take，然后执行任务#run。呃，这样最简单的线程池就实现了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NaiveThreadPool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; tasks   = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Thread[]                workers = <span class="keyword">new</span> Worker[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NaiveThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Thread worker : workers) &#123;</span><br><span class="line">            worker.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">        tasks.add(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Runnable task = tasks.take();</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    <span class="comment">// 任务执行异常</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>其余的什么corePoolSize、maximumPoolSize、不同种类的Queue、线程过期策略、任务拒绝策略，建议自行看<a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ThreadPoolExecutor.html" target="_blank" rel="noopener">文档</a>，已经很详细了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://superhx.github.io/2016/04/01/Java-Initialization-Order/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Robin Han">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="猿妙不可言">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/01/Java-Initialization-Order/" itemprop="url">Java Initialization Order</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-04-01T14:23:22+08:00">
                2016-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/04/01/Java-Initialization-Order/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/04/01/Java-Initialization-Order/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Main start\n"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Before new a B object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> B();</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"After new a B object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(C.constCvar);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(C.staticCVar);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Before new a C object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> C();</span><br><span class="line">        <span class="keyword">new</span> Out();</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"After new a C object"</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">new</span> Out(<span class="string">"Main end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Out</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Out</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"-------------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Out</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        System.out.println(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Out o1 = <span class="keyword">new</span> Out(<span class="string">"A static member o1 initialize"</span>);</span><br><span class="line">    <span class="keyword">public</span> Out o2 = <span class="keyword">new</span> Out(<span class="string">"A member o2 initialize"</span>);</span><br><span class="line"></span><br><span class="line">    &#123; <span class="keyword">new</span> Out(<span class="string">"A non-static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="keyword">new</span> Out(<span class="string">"A static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">()</span> </span>&#123; <span class="keyword">new</span> Out(<span class="string">"A constructor execute"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Out o3 = <span class="keyword">new</span> Out(<span class="string">"B static member o3 initialize"</span>);</span><br><span class="line">    <span class="keyword">public</span> Out o4 = <span class="keyword">new</span> Out(<span class="string">"B member o4 initialize"</span>);</span><br><span class="line"></span><br><span class="line">    &#123; <span class="keyword">new</span> Out(<span class="string">"B non-static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="keyword">new</span> Out(<span class="string">"B static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">()</span> </span>&#123; <span class="keyword">new</span> Out(<span class="string">"B constructor execute"</span>); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String constCvar = <span class="string">"const C member"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String staticCVar = <span class="string">"static C member"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="keyword">new</span> Out(<span class="string">"C static block execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">C</span><span class="params">()</span></span>&#123; <span class="keyword">new</span> Out(<span class="string">"C constructor execute"</span>); &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Main start</span><br><span class="line"></span><br><span class="line">Before new a B object</span><br><span class="line">-------------------------</span><br><span class="line">A static member o1 initialize</span><br><span class="line">A static block execute</span><br><span class="line">B static member o3 initialize</span><br><span class="line">B static block execute</span><br><span class="line">A member o2 initialize</span><br><span class="line">A non-static block execute</span><br><span class="line">A constructor execute</span><br><span class="line">B member o4 initialize</span><br><span class="line">B non-static block execute</span><br><span class="line">B constructor execute</span><br><span class="line">-------------------------</span><br><span class="line">After new a B object</span><br><span class="line"></span><br><span class="line">-------------------------</span><br><span class="line">const C member</span><br><span class="line">-------------------------</span><br><span class="line">C static block execute</span><br><span class="line">static C member</span><br><span class="line">-------------------------</span><br><span class="line">Before new a C object</span><br><span class="line">-------------------------</span><br><span class="line">C constructor execute</span><br><span class="line">-------------------------</span><br><span class="line">After new a C object</span><br><span class="line"></span><br><span class="line">Main end</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Robin Han</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/superhx" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Robin Han</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://blogrobinhan.disqus.com/count.js" async></script>
    

    

  




	





  










  





  

  

  

  

  

  

</body>
</html>
